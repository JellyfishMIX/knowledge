# 基于对象存储的文件存储设计思考



## 对象存储中删除的思考

Q: 我(钱士杰)

A: 乐哥(王乐)

### Q:

项目里使用了对象存储，文件实体存储在第三方服务商。自己项目的数据库表中只存文件的 url 和对象存储中的唯一标识码。如果这个文件在项目的数据库中被删除了（根据行业经验一般用逻辑删除不用 delete），那么对象存储中的文件需要删吗？比如qq群文件，他们的文件实体肯定是存在对象存储里了。

### A:

看业务需求和产品方案，作为技术，哪种方式应该都会实现。数据表里的记录如果是逻辑删除，对象存储中就不可以删除。

### Q:

mysql 里逻辑删除的记录，会一直是逻辑删除的状态吗，还是说过一两年会做 delete 清理呢。这个也是要看业务需求吗？

### A:

是的，也需要看业务需求。如果需要保留数据，保留多久。你还需要考虑，第三方对象存储，用于存储的磁盘容量多大，是否会归档、删除等。



## 对象存储中的文件实体，与数据表中记录的对应关系

Q: 我(钱士杰)

A: 乐哥(王乐)

### Q:

像qq群文件功能，那么多qq群那么多用户上传文件，肯定会有一模一样的（比如游戏资源，影视资源，肯定会出现这种情况，每个文件都还挺大）。目前对象存储技术，能做到快速识别要上传的文件，是否和已经存入的文件完全相同。

起初我是这么思考的，如果是为了节省存储成本，对象存储中完全相同的文件，只存储一份文件实体的话。接下来，项目 mysql 数据库中，每个用户上传的文件肯定是得有一个单独记录的，得记录上传者上传日期等信息（在数据表中单独一行）。多个用户在不同的群中，上传了 n 份完全相同的文件，数据表里会有 n 行记录。但是按照我的设计，对象存储里实体文件只存了一份。这样如果想删除对象存储里的文件实体的时候就很麻烦，需要保证 mysql 数据表里，这份文件实体对应的 n 行记录都是已删除的状态。这样的设计感觉复杂度就高了。我不知道这样做是否合适。

### A:

重复文件还是不要合并的好，大部分情况下是通过限制上传文件大小来控制。就业内目前的存储成本而言，硬盘空间不值钱，代码设计最好简单点。文件还没涉及修改，如果修改了会更复杂。设计方案时要考虑到日后可能的需求变更。

可以参考一下百度云盘，如果有用户分享，应该是拷贝了一份，可能第一次是直接引用。

