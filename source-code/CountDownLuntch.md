# CountDownLuntch 源码分析



## 案例

CountDownLunch 是 AQS 共享模式的经典用法，先给 state 设置一个值，比如 100。可以代表 100 个任务，每个线程执行完本次任务，就给 state -1，state 为 0 表示所有任务都执行完了。

场景：先用多线程执行完多个任务，在多个任务完成后，转为单线程执行。可以用来做多线程转单线程的同步点。

举例：

1. 之前实习的时候有个需求，每天早七点给全国三百多个城市的用户发送今日天气推送(push)。天气数据从中国天气网获取，即一个城市的天气数据是一次网络 IO。
2. 可以先用多线程去做天气数据的网络 IO，把 CountDownLunch 设置为城市的数量(即任务数量)，每个天气数据网络 IO 请求完并转换成内部数据结构后，就把 CountDownLunch - 1。
3. 考虑到多线程大量发送推送，对下游推送分发通道压力较大，在多线程请求并生成完天气数据后，转为单线程向下游分发通道传递。此处多线程转单线程，同步点就用 CountDownLunch 做的，当 CountDownLunch state 为 0 时，代表所有天气数据都生成完毕，可以向下游开始传递。

![Screen Shot 2022-08-09 at 10.16.19 AM](https://image-hosting.jellyfishmix.com/20220809111810.png)