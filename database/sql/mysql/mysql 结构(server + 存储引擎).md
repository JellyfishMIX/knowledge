# mysql 结构(server + 存储引擎)



## mysql 结构图

了解了 mysql 结构图，手写记录。

![mysql server 结构图](https://image-hosting.jellyfishmix.com/20220801203927.jpg)

mysql 大概可分为 server 层和存储引擎两部分。

1. myql server层包括连接器、查询缓存(8.0及之后已移除)、分析器、优化器、执行器等，涵盖 mysql 的大多数核心服务
   功能，以及所有的内置函数（如日期、时间、数学和加密函数等），所有跨存储引擎的功能都在
   这一层实现，比如存储过程、触发器、视图等。
2. mysql 的存储引擎层是可插拔式的，负责数据的存储和读写。支持 InnoDB、MyISAM
   Memory 等多个存储引擎。现在最常用的存储引擎是 InnoDB，它从 mysql 5.5.5版木开始成为了
   默认存储引擎。



## mysql server

1. 连接器：负责跟客户端建立连接、校验权限、维持和管理连接。
2. 查询缓存：mysql 在拿到一个请求后，会先到查询缓存看之前是否执行过这条语句，之前执行过的语句会以 key-value 的形式，被直接缓存在内存中。key 是查询的语句，value 是查询的结果。如果命中了查询缓存，会直接把 value 返回给客户端。但是不推荐使用查询缓存，因为查询缓存的失效非常频繁。只要表有更新，这个表上所有的查询缓存都会被清空，比较鸡肋。mysql 官方或许也意识到了这个问题，在 mysql 8.0 及之后，查询缓存功能整个被移除了。
3. 分析器：主要负责词法分析和语法分析，让 mysql 解析后知道自己应该做什么。
4. 优化器：给出 sql 的执行计划，选择最优的执行方案，例如是否使用索引，多表关联(join)时的连接顺序等。
5. 执行器：调用存储引擎提供的接口，进行读写操作。例如对于 `select * from demo_table where id = 10;` 如果 id 字段没有索引，执行器的操作顺序如下：
   1. 调用存储引擎接口读取这个表的第一行，判断 ID 是不是 10，如果不是则跳过，如果是则将这行存储在结果集中。
   2. 调用存储引擎接口读取"下一行"，重复相同的判断逻辑，直到读取到这个表的最后一行。
   3. 执行器将上述遍历过程中所有满足条件的行组成的结果集返回给客户端。执行器执行完成。
   4. 需要注意的是，执行器调用存储引擎读取一行，在存储引擎内部可能扫描了多行。和具体的存储引擎内部机制有关。